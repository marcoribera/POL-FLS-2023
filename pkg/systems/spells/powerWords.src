
use uo;
use os;

include "include/client";
include "include/sysEvent";
include "include/say";
include "include/tnmagery";
include ":fls_core:fls_characters";

program clericPowerWords(parms)
   detach();
   var who := parms[1];
   var pid := GetPid();
   SetObjProperty(who, "#clericpid", pid);

   RegisterForSpeechEvents( who, 3 );
   EnableEvents( SYSEVENT_SPEECH, 1 );
   
   var event;
   while(who.connected)
      event := wait_for_event( 120 );
      if ( event && !who.dead && event.source ==  who && event.type == SYSEVENT_SPEECH)
         var shaman_list := GetObjProperty(who, "shaman_list");
         var cantrips := GetObjProperty(who, "cantrips");
         
         if (!shaman_list) shaman_list := array{}; endif;
         if (shaman_list.size() < 1 || GetObjProperty(who, "#Casting"))
            continue;
         endif

         var spell_id := 1;
         foreach spell in cantrips
            var verified := 0;
            if (!spell.powerwords || spell.used == 1)
                spell_id++;
               continue;
            endif
            var text := Lower(event.text);
            
            foreach powerword in splitwords((spell.powerwords))
               if (Lower(text).find(Lower(powerword)))
                  verified += 1;
               endif
               sleepms(2);
            endforeach

            if (verified == splitwords(spell.powerwords).size())
               Start_Script(":spells:cast_spell", {who, spell, "Shaman"});
               break;
            endif
            spell_id++;
            sleepms(2);
         endforeach
         spell_id := 1;
         foreach spell in shaman_list
            var verified := 0;
            if (!spell.powerwords || spell.used == 1)
                spell_id++;
               continue;
            endif
            var text := Lower(event.text);
            
            foreach powerword in splitwords((spell.powerwords))
               if (Lower(text).find(Lower(powerword)))
                  verified += 1;
               endif
               sleepms(2);
            endforeach

            if (verified == splitwords(spell.powerwords).size())
               Start_Script(":spells:cast_spell", {who, spell, "Shaman"});
               shaman_list[spell_id].used := 1;
               SetObjProperty(who, "shaman_list", shaman_list);
               break;
            endif
            spell_id++;
            sleepms(2);
         endforeach
      endif
      sleepms(10);
   endwhile
endprogram
